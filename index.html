<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì„œìš¸Â·ê²½ê¸° í”„ë¡œì íŠ¸ í˜„í™© - ì»¬ëŸ¬ ë§¤ì¹­ ë²„ì „</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --border: #E0E0E0; }
        body { font-family: 'Noto Sans KR', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; color: #333; }
        
        header { padding: 10px 20px; border-bottom: 1px solid var(--border); background: white; z-index: 1000; display: flex; justify-content: space-between; align-items: center; height: 50px; }
        h1 { margin: 0; font-size: 16px; font-weight: 700; }

        .switch-container { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #0055A4; }
        input:checked + .slider:before { transform: translateX(20px); }

        .layout { display: flex; flex: 1; overflow: hidden; }
        #map { flex: 1; height: 100%; z-index: 1; }
        
        .sidebar { width: 320px; display: flex; flex-direction: column; background: #ffffff; border-left: 1px solid var(--border); z-index: 2; }
        .sidebar-content { padding: 15px; overflow-y: auto; flex: 1; }
        body.full-map-mode .sidebar { display: none; }

        /* ë“œë˜ê·¸ ê°€ëŠ¥í•œ ë¼ë²¨ (í…Œë‘ë¦¬ ìƒ‰ìƒì€ JSì—ì„œ ë™ì  ë¶€ì—¬) */
        .draggable-label-container {
            background: rgba(255, 255, 255, 0.98);
            border-width: 2px;
            border-style: solid;
            border-radius: 6px;
            padding: 8px 10px;
            box-shadow: 4px 4px 12px rgba(0,0,0,0.1);
            text-align: left;
            font-size: 11px;
            width: max-content;
            cursor: grab;
            user-select: none;
        }
        
        .label-title { font-weight: 700; font-size: 12px; display: block; border-bottom: 1px solid #eee; padding-bottom: 4px; margin-bottom: 4px; }
        .label-content { display: block; color: #555; margin: 1px 0; }

        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 10px 5px; font-size: 12px; border-bottom: 2px solid var(--border); text-align: left; }
        td { padding: 10px 5px; border-bottom: 1px solid var(--border); font-size: 12px; }
        .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; color: white; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <h1>ì„œìš¸Â·ê²½ê¸° í”„ë¡œì íŠ¸ í˜„í™© (ì»¬ëŸ¬ ì„¸ë¶„í™”)</h1>
    <div class="switch-container">
        ë¼ë²¨ í¸ì§‘ ëª¨ë“œ
        <label class="switch">
            <input type="checkbox" id="mode-toggle">
            <span class="slider"></span>
        </label>
    </div>
</header>

<div class="layout">
    <div id="map"></div>
    <div class="sidebar">
        <div class="sidebar-content">
            <h3 style="font-size: 14px;">ğŸ“‹ í”„ë¡œì íŠ¸ í˜„í™© ëª©ë¡</h3>
            <table>
                <thead><tr><th width="30">No</th><th>ì •ë³´ / ë‹¨ê³„</th></tr></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // í”„ë¡œì íŠ¸ ë‹¨ê³„ë³„ ì»¬ëŸ¬ ë§¤í•‘ í•¨ìˆ˜
    function getStepColor(stage) {
        if (stage.includes("í˜‘ì•½") || stage.includes("ë°œì£¼")) return "#E53935"; // Red
        if (stage.includes("ì„¤ê³„")) return "#1E88E5"; // Blue
        if (stage.includes("ì»¨ì„¤íŒ…")) return "#43A047"; // Green
        if (stage.includes("ê²€í† ")) return "#8E24AA"; // Purple
        return "#757575"; // Gray (Default)
    }

    const projects = [
        { id: 1, name: "ì„œìš¸ëŒ€ 68-1ê´€", loc: "ê´€ì•…êµ¬", client: "ì„œìš¸ëŒ€", vol: "33", stage: "ê¸°ë³¸ì„¤ê³„", lat: 37.4533582, lng: 126.9571625 },
        { id: 2, name: "ì„±ë‚¨ ì •ìˆ˜ì¥", loc: "ì„±ë‚¨ì‹œ", client: "ìˆ˜ìì›ê³µì‚¬", vol: "74(91)", stage: "í˜‘ì•½ì¤€ë¹„", lat: 37.4127307, lng: 127.1087071 },
        { id: 3, name: "ê´‘ëª…í•™ì˜¨ ê³µì›ë™", loc: "ê´‘ëª…ì‹œ", client: "ê²½ê¸°ë„ì‹œê³µì‚¬", vol: "58", stage: "ë°œì£¼ëŒ€ê¸°", lat: 37.4101401, lng: 126.8635773 },
        { id: 4, name: "íƒœí‰ë¡œë¹Œë”© FIT", loc: "ì¤‘êµ¬", client: "ì´ì§€ìŠ¤ìì‚°", vol: "3,097", stage: "ì‹¤ì‹œì„¤ê³„", lat: 37.5630066, lng: 126.9757363 },
        { id: 5, name: "ì„œìš¸ì—­ ì—…ë¬´ì§€êµ¬", loc: "ìš©ì‚°êµ¬", client: "ì‚¼ì„±ë¬¼ì‚°", vol: "276", stage: "ì»¨ì„¤íŒ…", lat: 37.5563060, lng: 126.9744798 },
        { id: 6, name: "ë™ì„œìš¸í„°ë¯¸ë„ FIT", loc: "ê´‘ì§„êµ¬", client: "ì‹ ì„¸ê³„", vol: "506", stage: "ì»¨ì„¤íŒ…", lat: 37.5356993, lng: 127.0957650 },
        { id: 7, name: "ASML ì›ì‚¼ Office", loc: "ìš©ì¸ì‹œ", client: "ASML", vol: "1,100", stage: "ë°œì£¼ëŒ€ê¸°", lat: 37.1543160, lng: 127.3182542 },
        { id: 8, name: "í¬ë˜í”„í†¤ C3 ì‹ ì¶•", loc: "ì„±ë™êµ¬", client: "í¬ë˜í”„í†¤", vol: "252", stage: "ì‚¬ì „ì»¨ì„¤íŒ…", lat: 37.5408084, lng: 127.0574413 },
        { id: 9, name: "ì• í”Œíƒ€ì›Œ", loc: "ì†¡íŒŒêµ¬", client: "ì• í”ŒA&M", vol: "ê²€í† ì¤‘", stage: "ê²€í† ì¤‘", lat: 37.5105279, lng: 127.0790511 },
        { id: 10, name: "ê°•ë‚¨ 358íƒ€ì›Œ", loc: "ê°•ë‚¨êµ¬", client: "HDCìì‚°", vol: "1,629", stage: "ì‚¬ì „ì»¨ì„¤íŒ…", lat: 37.4950386, lng: 127.0297037 },
        { id: 11, name: "ë…¼í˜„ë™ ê°œë°œ ê²€í† ", loc: "ê°•ë‚¨êµ¬", client: "ì‹ ì„¸ê³„", vol: "1,926", stage: "ì‚¬ì „ì»¨ì„¤íŒ…", lat: 37.5111837, lng: 127.0225186 },
        { id: 12, name: "ì‚¼ì„±ë™ 168 ì˜¤í”¼ìŠ¤", loc: "ê°•ë‚¨êµ¬", client: "ë‘ë‚˜ë¬´", vol: "500", stage: "ì‚¬ì „ì»¨ì„¤íŒ…", lat: 37.5103722, lng: 127.0629707 },
        { id: 13, name: "ê´€ìˆ˜8ì§€êµ¬ ì¬ê°œë°œ", loc: "ì¢…ë¡œêµ¬", client: "NHì¦ê¶Œ", vol: "1,290", stage: "ì‚¬ì „ì»¨ì„¤íŒ…", lat: 37.5685801, lng: 126.9900656 },
        { id: 14, name: "ì—­ì‚¼ SI íƒ€ì›Œ", loc: "ê°•ë‚¨êµ¬", client: "ì´ì§€ìŠ¤ìì‚°", vol: "1,960", stage: "ì‚¬ì „ì»¨ì„¤íŒ…", lat: 37.5015926, lng: 127.0377365 }
    ];

    const map = L.map('map').setView([37.51, 127.05], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    const projectLayer = L.layerGroup().addTo(map);
    const draggableGroup = L.layerGroup().addTo(map);
    const markers = [];

    const avgLat = projects.reduce((sum, p) => sum + p.lat, 0) / projects.length;
    const avgLng = projects.reduce((sum, p) => sum + p.lng, 0) / projects.length;

    projects.forEach(p => {
        const color = getStepColor(p.stage);
        
        // 1. í•€ ìƒì„±
        const pin = L.circleMarker([p.lat, p.lng], {
            radius: 6, fillColor: color, color: "#fff", weight: 2, fillOpacity: 1
        }).addTo(projectLayer);

        // 2. ì‚¬ì´ë“œë°” í…Œì´ë¸”
        document.getElementById('table-body').innerHTML += `
            <tr>
                <td>${p.id}</td>
                <td>
                    <b>${p.name}</b><br>
                    <span class="status-badge" style="background:${color}">${p.stage}</span>
                </td>
            </tr>
        `;

        // 3. ë“œë˜ê·¸ ë¼ë²¨ (í…Œë‘ë¦¬ ìƒ‰ìƒ color ë³€ìˆ˜ ì ìš©)
        const latDiff = p.lat - avgLat;
        const lngDiff = p.lng - avgLng;
        const initialLabelPos = [p.lat + (latDiff * 2.5), p.lng + (lngDiff * 3.5)];

        const labelHtml = `
            <div class="draggable-label-container" style="border-color: ${color};">
                <span class="label-title" style="color: ${color};">${p.id}. ${p.name}</span>
                <span class="label-content">ğŸ“ ${p.loc} | ğŸ¢ ${p.client}</span>
                <span class="label-content">ğŸ“¦ <b>${p.vol}</b> | âš™ï¸ <b>${p.stage}</b></span>
            </div>
        `;

        const labelIcon = L.divIcon({ html: labelHtml, className: '', iconAnchor: [0, 0] });
        const labelMarker = L.marker(initialLabelPos, { icon: labelIcon, draggable: true });
        const polyline = L.polyline([[p.lat, p.lng], initialLabelPos], { color: color, weight: 1.5, dashArray: '4, 4', opacity: 0.7 });

        labelMarker.on('drag', (e) => polyline.setLatLngs([[p.lat, p.lng], e.target.getLatLng()]));

        markers.push({ pin, labelMarker, polyline, data: p, color: color });
    });

    function updateMode() {
        const isEdit = document.getElementById('mode-toggle').checked;
        if (isEdit) {
            document.body.classList.add('full-map-mode');
            markers.forEach(m => {
                m.pin.unbindTooltip();
                m.labelMarker.addTo(draggableGroup);
                m.polyline.addTo(draggableGroup);
            });
        } else {
            document.body.classList.remove('full-map-mode');
            draggableGroup.clearLayers();
            markers.forEach(m => {
                m.pin.bindTooltip(`<b>${m.data.name}</b><br><span style="color:${m.color}">${m.data.stage}</span>`, { direction: 'top', html: true });
            });
        }
        setTimeout(() => map.invalidateSize(), 400);
    }

    document.getElementById('mode-toggle').addEventListener('change', updateMode);
    updateMode();
</script>
</body>
</html>